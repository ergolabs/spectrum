\subsection{A Complete Description of the Spectrum Protocol}\label{subsec:a-complete-description-of-the-spectrum-protocol}
The purpose of this section is to formally specify the code of the Spectrum protocol.

\subsubsection{The Main Protocol}
\phantomsection
\textbf{Spectrum protocol} is as follows:\label{apndx:spectrum-protocol}
\begin{protocol}
    \caption{$\textsf{Spectrum}(P, \mathcal{G}_{\text{Ledger}}, \mathcal{G}_{\text{ImpLClock}}, \mathcal{G}_{\text{RO}}, \mathcal{F}^{\Delta}_{\text{N-MC}})$}
    \begin{algorithmic}
        \State $\textbf{Global variables:}$
        \begin{itemize}
            \item[\textbf{--}] Read-only: $R, K_{\text{f}}, K_{\text{g}}$
            \item[\textbf{--}] Read-write: $v^{\text{vrf}}_P, v^{\text{kes}}_P, T^{\text{cons}, k}_{P, n}, T^{\text{lead}, k}_{P, n}, T^{\text{sync}}_{P, n},sl_j, e_n, \textsf{localTime}, \textsf{state}^{j},$
            \item[] $\textsf{buffer}, \textsf{syncBuffer}, \textsf{isSync}, \textsf{isInit}, \textsf{fetchCompleted}, \textsf{EpochUpdate(.)}$.
        \end{itemize}
        \State $\textbf{Registration/De-registration:}$

        todo
        \State $\textbf{Interacting with the main Ledger:}$
        Upon receiving a ledger-specific input $I \in (\textsf{\scriptsize{SUBMIT}}, \dots), (\textsf{\scriptsize{READ}}, \dots),
        (\textsf{\scriptsize{MAINTAIN-LEDGER}}, \dots), (\textsf{\scriptsize{EXPORT-TIME}}, \dots),$ verify\
        Ô¨Årst that all resources are available.
        If not all resources are available, then ignore the input, otherwise execute one of the following\
        steps depending on the input $I$:
        \begin{itemize}
            \item[\textbf{--}] \textbf{If} $I = (\textsf{\scriptsize{SUBMIT}}, \textsf{tx}):$ set $\textsf{buffer} \leftarrow \textsf{buffer} || \textsf{tx}$;
            \item [] send $(\textsf{\scriptsize{MULTICAST}}, \textsf{tx})$ to $\mathcal{F}^{\Delta}_{\text{N-MC}}$.
            \item[\textbf{--}] \textbf{If} $I = (\textsf{\scriptsize{MAINTAIN-LEDGER}}, P):$ invoke the protocol \hyperref[apndx:main-ledger-protocol]{$\textsf{LedgerMaintenance}$}$(P, R, \mathcal{C}_{\text{loc}})$;
            \item[] if $\textsf{LedgerMaintenance}$ halts then halt the $\textsf{Spectrum}$ protocol execution and ignore all future inputs.
            \item[\textbf{--}] \textbf{If} $I = (\textsf{\scriptsize{READ}}, P):$ invoke the protocol \hyperref[apndx:read-state-protocol]{$\textsf{ReadState}$}$(P, R, \mathcal{C}_{\text{loc}})$;
            \item[\textbf{--}] \textbf{If} $I = (\textsf{\scriptsize{EXPORT-TIME}}, P):$ if $\text{isSync} \vee \textsf{isInit} = \textsf{false}$ then return $\textsf{false}$ to party $P$;
            \item[] Otherwise call \hyperref[apndx:update-time-protocol]{$\textsf{UpdateTime}$}$(P, R)$ and do:
            \begin{enumerate}
                \item Set the highest epoch value $e_n \leftarrow \textsf{EpochUpdate()}$.
                \item Return $(\textsf{localTime}, e_n)$ to the caller.
            \end{enumerate}
        \end{itemize}

        \State $\textbf{Handling calls to the shared setup:}$
        \begin{itemize}
            \item[\textbf{--}] \textbf{If} $I = (\textsf{\scriptsize{CLOCK-GET}}, \text{sid}_\text{C}):$ forward it\
            to $\mathcal{G}_{\text{ImpLClock}}$ and return its response.
            \item[\textbf{--}] \textbf{If} $I = (\textsf{\scriptsize{CLOCK-UPDATE}}, \text{sid}_\text{C}):$ ,  record that a clock-update was received in the current round.
            If the party is registered to all its setups,  then do nothing further.
            Otherwise,  do the following operations before concluding this round:
            \begin{enumerate}
                \item If this instance is currently time-aware but otherwise stalled or offline, then set $\textsf{localTime} \leftarrow \textsf{UpdateTime}(P, R)$\
                and evolve the KES signing key.
                If the party has passed a synchronization slot, then set $\textsf{isSync}  \leftarrow  \textsf{false}$.
                \item If this instance is only stalled but $\textsf{isSync}  =  \textsf{true}$, then additionally execute\
                \hyperref[apndx:fetch-info-protocol]{$\textsf{FetchInformation}$}$(P, sid)$, extract all new synchronization beacons from the fetched chains,\
                record their arrival times and set $\textsf{fetchCompleted}  \leftarrow  \textsf{true}$.
                Any unfinished interruptible execution of this round is marked as completed.
                \item Forward $(\textsf{\scriptsize{CLOCK-UPDATE}}, \text{sid}_\text{C})$ to $\mathcal{G}_{\text{ImpLClock}}$ to finally conclude the round.
            \end{enumerate}
            \item[\textbf{--}] \textbf{If} $I = (\textsf{\scriptsize{EVAL}}, \text{sid}_{\text{RO}}, x):$ forward it\
            to the $\mathcal{G}_{\text{RO}}$ and output its response.
        \end{itemize}


    \end{algorithmic}\label{alg:spectrum-protocol}
\end{protocol}

\subsubsection{Fetching information, stake distribution and time update}
\input{appendix-fetching-and-updates.tex}

\subsubsection{Validity Checks}
\input{appendix-validation.tex}

\subsubsection{Chain Selection Rules}
\input{appendix-chain-selection.tex}

\subsubsection{Ledger Maintenance}
\input{appendix-ledger-maintenance.tex}

\subsubsection{Joining the protocol}
\input{appendix-registration.tex}

\newpage

\subsection{List of Symbols}\label{subsec:list-of-symbols}
\input{appendix-list-of-symbols.tex}





