\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{mathtools}
\usepackage[dvipsnames]{xcolor}
\usepackage{color}
\definecolor{SpectrumLavander}{HTML}{dadeed}
\sloppy

\title{Spectrum: Cross-chain interoperability at scale}
\author{Spectrum Labs}
\date{February 2023}

\begin{document}
    \pagecolor{SpectrumLavander}

    \maketitle


    \section{Introduction}\label{sec:introduction}

    Following the success of Bitcoin, many blockchain-based cryptocurrencies have been developed and deployed.
    To meet different requirements in various scenarios, a great number of heterogeneous blockchains have emerged.
    However, most present blockchain platforms are isolated systems.
    Therefore, interoperability between blockchains become one of the key issues
    that prevent the blockchain technology from wide adoption.

    \subsection{Existing Solutions}\label{subsec:existing-solutions}

    \subsubsection{Centralized Solutions}\label{subsubsec:centralized-solutions}

    A classical solution to cross-chain interoperability is a trusted oracle that registers some event on one blockchain and performs the required action on the other.
    Centralized oracles provide fast and cheap transactions but lack a key feature , decentralization.
    The liquidity of a protocol built on this approach is custodial, which is a centralized approach similar to CeFi when users deposit their funds to an exchangeâ€™s wallet:
    \begin{enumerate}
        \item A system is not sustainable when it depends on a single party
        \item If the oracle goes down unfinished swaps can appear frozen halfway
        \item A centralized oracle can censor transactions
        \item A malicious oracle can perform a man-in-the-middle attack by sending inaccurate data.
    \end{enumerate}

    \subsubsection{Semi-Centralized Solutions}\label{subsubsec:semi-centralized-solutions}

    Another common approach involves intermediate network consisting of fixed number of hand-picked oracles facilitating the transfer of data among multiple blockchains.
    PoA or PoS consensus is used with high collateral and a small (less than a hundred) number of nodes.
    Often, all funds transferred between blockchains are stored on some kind of threshold wallets, which are generated by the participants of the intermediate network, thus they are controlled by a fixed group of oracle operators.
    This method is inherently similar to the first one, although it is slightly more decentralized.


    \section{Related Work}\label{sec:related-work}

    todo


    \section{System Model}\label{sec:system-model}

    Spectrum operates in untrustworthy network environment that can arbitrary delay, re-order, drop or duplicate messages.
    To avoid the FLP impossibility the network is assumed to have weak synchrony property.
    The system is composed of a set of nodes $N$.
    Each node $n \in N$ is able to generate key-pairs $(PK_n, SK_n)$ without trusted public key infrastructure and is able to sign messages $sign: (SK_n, m) \rightarrow \sigma$.
    Each node $n \in N$ is also able to verify signatures $verify: (\sigma, PK_n, m) \rightarrow 0 | 1$.
    Each node $n \in N$ is associated with a unique wallet holding a balance of tokens $B_n$.

    At any time $t$ a susbset $V_t \subseteq N$ of nodes is controlled by an adversary and are considered faulty.
    Byzantine nodes can divert from the protocol and collude to attack the system.
    The remaining honest nodes follow the protocol.
    We assume that the total balance of all faulty nodes is less than 1/3 of the total balance $B$ of all nodes.


    \section{Goals}\label{sec:goals}

    The resultated system should have the following properties:
    \begin{enumerate}
        \item \textbf{Decentralization.} The system should be decentralized.
        \item \textbf{Interoperability.} The system should be able to support a large number of heterogeneous blockchains.
        \item \textbf{Openness.} The system should allow anyone to participate in consensus permissionlessly.
        \item \textbf{Scalability.} The system should be able to operate normally while maintainign sufficiently large consesnsus groups.
        \item \textbf{Security.} The system should be able to withstand Sibil attacks.
        \item \textbf{Sustainability.} The system should be able to tolerate faults of the connected blockchains.
    \end{enumerate}


    \section{System Design}\label{sec:system-design}

    This section presents Spectrum protocol design starting from a naive approach based on PBFT and gradually addressing the challanges.

    \subsection{Strawman Design: PBFTNetwork}\label{subsec:strawman-cross-chain-protocol}

    \subsection{Bootstrapping}\label{subsec:bootstrapping}

    The system is bootstrapped in a trusted way.
    A manually picked set of validators $V_0$ is assigned to the first epoch $E_0$.
    On-chain vaults are initialized with an aggregated public key $aPK_0$ of the inititial comettee.

    \subsection{Protocol Flow}\label{subsec:protocol-flow}

    \begin{enumerate}
        \item Registration.
        Before an epoch starts, all Spectrum stakeholders can register for becoming an committee member.
        To get a chance of becoming a member of $V_n$ in the next epoch $E_n$ they register in a lottery
        by publishing their public keys $PK_c$ and locking collateral.
        \item Lottery.
        Once registration is done, nodes in $V_{n-1}$ compute $selectComettee: (C_n, R_n) \rightarrow V_n$,
        where  $C_n$ is a candidates pool, $R_n$ is a public random number.
        \item Comettee key aggregation.
        Once new comettee is selected, nodes in $V_n$ aggregate their individual public keys $\{PK_i\}$ into
        a joint one $aPK_n$.
        \item Comettee transition.
        Nodes in $V_{n-1}$ publish cross-chain message $M_n : (aPK_n, \sigma_{n-1})$ , where $aPK_n$ is
        an aggregated public key of the new comettee $V_n$ , $\sigma_{n-1}$ is an aggregated signature of
        $M_n$ such that $Verify(\sigma_{n-1}, aPK_{n-1}, Mn) = 1$.
        Vaults are updated such that $Vault\{(E_{n-1}, aPK_{n-1})\} \coloneqq (E_n, aPK_n)$.
        \item Decentaralized Asset Management (Custodial).
        Nodes in $V_n$ observe events on supported L1 chains, agree on the set of updates
        and compute state outbound state transitions accordingly.
        \item Notarisation (Non-custodial).
        Nodes in $V_n$ observe events on supported L1 chains, batch updates, collectively sign them and
        publish on-chain.
    \end{enumerate}


    \subsection{Spectrum's State Transition Function}
    Usually State Transition Function (STF) of a ledger looks like:

    \begin{equation}
        f(S, T) \rightarrow S',\label{eq:equation1}
    \end{equation}
    where $S$ - current state of the ledger, $T$ - a set of transactions, $S'$ - resulting state of the ledger.
    Spectrum's STF as long as it operates partially on top of other ledgers, can be viewed as

    \begin{equation}
        \chi(S, S_O, T_I) \rightarrow (S', T_O),\label{eq:equation2}
    \end{equation}
    where $S$ - current Spectrum's state, $S_O$ - observed outbound state of connected ledgers, $T_I$ - a set of inbound transactions, $S'$ - resulting state of spectum's ledger, $T_O$ - resulting set of outbound transactions that must be settled on connected L1s.

    \subsubsection{Achieving finality of outbound transactions}
    Most ledgers do not guarantee instant finality of transaction, that means that any (or all) transactions of $T_O$ may not be applied to corresponding ledgers in the end. Also the number of confirmations in different networks have different reliability.


    Using the number of epochs $\Delta E$ that have passed in the Spectrum network, developers should be able to receive information about the number of blocks that have passed in all connected L1 blockchains during this period of time. The duration of the block in each L1 blockchain is different, but the average values are preserved for a certain period of time $\Delta T >> d_s$, where $d_s$ is the duration of Sepctrum's epoch. Thus, after each $\Delta T$ time interval, Spectrum network will update the set of constants:
    \begin{equation}
        \{d_{i}\}_{i=1}^{M};\
        \{c_{i}\}_{i=1}^{M}\label{eq:equation3}
    \end{equation}
    where $d_i$ - block duration of $i$-th connected L1 blockchain, $c_i$ - default reliable number of confirmations in $i$-th connected L1 blockchain, $M$ - total number of connected L1 blockchains. Using the data above, each $\Delta E$ of the Spectrum's epochs can be associated with the delta of blocks that have passed on in any connected blockchain:
    \begin{equation}
        \left\{ \left\lfloor\Delta E \cdot \frac{d_s}{d_i}\right\rfloor \right\}_{i=1}^{N}\label{eq:equation4}
    \end{equation}


    Each pair of inbound and outbound transactions must contain the following information in the context:
    \begin{enumerate}
        \item Parent L1 blockchain ID $p_{id}$ which UTXO of the corresponding inbound transaction belongs to;
        \item Spectrum epoch number $E_{settled}$ at which the corresponding inbound transaction settled at the Spectrum network.
    \end{enumerate}
    When forming outbound transaction, developers can specify a reliability factor $C$. This factor will be compared with the ratio of the number of blocks passed on the parent L1 blockchain of the inbound transaction to the default reliable number of confirmations $c_i$ of this network:
    \begin{equation}
        \theta(i-p_{id})\cdot \left\{\frac{1}{c_i} \cdot \left\lfloor (E-E_{settled}) \cdot \frac{d_s}{d_i}\right\rfloor\right\}_{i=1}^{M} >= C\label{eq:equation6}
    \end{equation}
    where $E$ - current Spectrum epoch number; $\theta(x)$ - indicator function which is 1 at $x = 0$, otherwise 0.


    Thus, only those UTXO will be included in outbound transactions for which the number of confirmations $N_c>=C\cdot c_i$.

    \subsubsection{Formal STF definition}
    The Spectrum's State Transition Function function can be defined as follows:

    \begin{enumerate}

        \item For each input in $T_I$ referenced UTXO must exist in associated L1 and signature must match it's owner;

        \item For each input in $T_O$ referenced UTXO must exist in $S$ and aggregated signature of Spectrum's validators must be provided;

        \item Outbound transactions $T_O$ must include only those UTXO from the $S$ for which the number of confirmations in the parent network are reliable, i.e. $N_c>=C\cdot c_i$;

        \item Sum of all assets that are transferred into the Spectrum vault in $T_I$ must be not less than the difference between all stored assets in $S_O$ and $S$;

        \item Sum of all assets that are settled on all connected L1s in $T_O$ must not exceed the difference between all stored assets in $S_O$ and $S'$;

        \item If the number of connected blockchains has increased by $m$, then the corresponding constants $\{d_{i}^{'}\}_{i=1}^{m},\ \{c_{i}^{'}\}_{i=1}^{m}$ must be added to constants sets.

        \item If the period of time $\Delta T$ has passed, new constants sets $\{d_{i}^{'}\}_{i=1}^{M},\ \{c_{i}^{'}\}_{i=1}^{M}$ should be provided, and $\forall i \in M: {c^{'}_i >= c^{'}_i \vee d^{'}_i >= d^{'}_i}$;

        \item Returns $S'$ with all $T_I$ output UTXO added and $T_O$ input UTXO removed from vault.

    \end{enumerate}


    \section{Applications}\label{sec:applications}

    \subsection{Cross-Chain Oracle}\label{subsec:cross-chain-oracle}
    In oracle mode of operation the system is capable of providing a notarized set of events observed on supported blockchains.

    \subsection{Custodial Asset Management}\label{subsec:custodial-asset-management}
    In custodial mode of operation the system is capable of managing user assets which are stored on corresponding blockchains in \emph{vaults}.
    Each vault stores epoch number $n$, an aggregated public key $aPK_n$ of the current validator set $V_n$ and
    is guarded with a script (smart-contract) capable of performing verification of
    an aggregated signature $verify: (\sigma_n, m_n, aPK_n) \rightarrow 0 | 1$.

    \paragraph{Natively Cross-Chain Applications}
    Decentralized custodial management in conjunction with a computational layer can be highly beneficial for expanding the capabilities of the system.
    Moving beyond simple bridges to what we call \emph{Natively Cross-Chain Applications} (NCCAs).
    NCCAs are applications that are deployed in cross-chain network and are capable of interacting with other blockchains without the need of external oracles or bridges.

\end{document}